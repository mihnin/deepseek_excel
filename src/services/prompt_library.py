# modules/prompt_library.py
from typing import Dict, List, Tuple, Any, Union

def get_business_prompts() -> Tuple[Dict[str, Dict[str, str]], Dict[str, str]]:
    """
    Возвращает структурированную библиотеку промптов для бизнес-задач.
    
    Returns:
        Tuple[Dict[str, Dict[str, str]], Dict[str, str]]: 
            Первый элемент - словарь категорий промптов,
            Второй элемент - плоский словарь для выбора в интерфейсе
    """
    
    prompts = {
        "Общая аналитика": {
            "Краткая саммаризация": "Сделай краткое и информативное резюме следующего текста в 2-3 предложениях, сохраняя ключевые факты и выводы:",
            "Расширенная саммаризация": "Создай структурированное резюме текста объемом 5-7 предложений. Выдели ключевые тезисы, цифры и выводы. Сохрани тон и направленность исходного текста:",
            "Ключевые моменты": "Выдели 3-5 самых важных ключевых моментов из текста в виде маркированного списка:",
            "Бизнес-рекомендации": "На основе этих данных сформулируй 2-3 конкретных бизнес-рекомендации с обоснованием их потенциальной эффективности:",
            "SWOT-анализ": "Проведи краткий SWOT-анализ по данной информации (сильные стороны, слабые стороны, возможности, угрозы):",
            "Извлечение метрик": "Извлеки из текста все числовые показатели, даты и ключевые метрики в структурированном виде. Сгруппируй связанные метрики:",
        },
        
        "Работа с клиентами": {
            "Анализ отзыва": "Проанализируй этот отзыв клиента. Определи общую тональность, ключевые проблемы, уровень удовлетворенности и предложи меры реагирования:",
            "Категоризация обращения": "Определи категорию обращения клиента (жалоба, запрос информации, предложение, благодарность), оцени приоритет (низкий/средний/высокий) и порекомендуй отдел для обработки:",
            "Выявление потребностей": "На основе данного текста клиента выяви его явные и скрытые потребности, болевые точки и ожидания. Предложи подходящие продукты/услуги из стандартного ассортимента:",
            "Улучшение коммуникации": "Перепиши этот текст коммуникации с клиентом, сделав его более дружелюбным, эмпатичным и ориентированным на решение проблемы клиента:",
            "Прогноз оттока": "Оцени риск оттока клиента на основе этой коммуникации по шкале от 1 до 5. Укажи ключевые индикаторы риска и рекомендуемые удерживающие действия:",
        },
        
        "Маркетинг": {
            "Оптимизация текста": "Улучши этот маркетинговый текст, сделав его более убедительным, конкретным и ориентированным на целевую аудиторию. Сохрани ключевые сообщения, но усиль призыв к действию:",
            "Анализ конкурента": "Проанализируй этот текст о конкуренте и выяви их сильные стороны, уникальные преимущества, целевую аудиторию и возможные слабости. Предложи как мы можем дифференцироваться:",
            "SEO-оптимизация": "Переработай этот текст для лучшей SEO-оптимизации. Выдели 3-5 ключевых слов, которые должны быть включены, и перепиши текст с их органичным использованием, сохраняя читаемость:",
            "Адаптация под аудиторию": "Адаптируй этот общий маркетинговый текст для конкретной целевой аудитории: [описание аудитории из доп. столбца]. Сделай акцент на релевантных для этой аудитории преимуществах:",
            "Создание заголовков": "Создай 5 вариантов привлекательных заголовков для рекламы на основе этого описания продукта/услуги. Каждый заголовок должен быть не более 60 символов и содержать ключевую выгоду:",
        },
        
        "Финансы и отчетность": {
            "Анализ финансовых данных": "Проанализируй эти финансовые показатели. Выяви ключевые тренды, отклонения от плана и потенциальные области для оптимизации расходов:",
            "Пояснение к отчету": "Создай лаконичное пояснение к этим финансовым данным для нетехнических руководителей. Объясни значение ключевых показателей и их влияние на бизнес понятным языком:",
            "Прогноз на основе данных": "На основе этих исторических финансовых данных предложи обоснованный прогноз на следующий квартал. Учти сезонность и выявленные тренды:",
            "Упрощение сложных терминов": "Преобразуй этот текст с финансовой и юридической терминологией в понятное объяснение для рядовых сотрудников. Сохрани ключевую информацию, но избегай специализированных терминов:",
            "Риск-анализ": "Проведи анализ потенциальных финансовых рисков на основе этих данных. Для каждого выявленного риска укажи вероятность, возможное влияние и рекомендуемые меры минимизации:",
        },
        
        "HR и внутренние коммуникации": {
            "Оптимизация вакансии": "Улучши это описание вакансии, сделав его более привлекательным для кандидатов. Чётко опиши требования, обязанности и преимущества работы. Добавь элементы корпоративной культуры:",
            "Анализ резюме": "Проанализируй это резюме на соответствие требованиям позиции. Выдели сильные стороны кандидата, потенциальные области для вопросов на интервью и общую рекомендацию (подходит/не подходит/возможно):",
            "Обратная связь по работе": "Преобразуй эти заметки по работе сотрудника в конструктивную обратную связь. Выдели достижения, области для улучшения и конкретные рекомендации по развитию:",
            "Улучшение инструкции": "Переработай эту внутреннюю инструкцию, сделав её более понятной, структурированной и удобной для использования. Добавь логичные подзаголовки и нумерацию шагов где необходимо:",
            "Анализ вовлеченности": "Проанализируй этот комментарий сотрудника из опроса вовлеченности. Определи уровень удовлетворенности, ключевые проблемы и предложи меры по улучшению вовлеченности:",
        },
        
        "Текстовая аналитика по всей таблице": {
            "Общие тренды": "Проанализируй все данные и выяви основные тренды, повторяющиеся темы и ключевые инсайты. Структурируй выводы по категориям актуальности и значимости:",
            "Сегментация данных": "Проанализируй всю таблицу и предложи логичную сегментацию данных по выявленным паттернам. Для каждого сегмента дай краткую характеристику и приблизительный объем:",
            "Аномалии и выбросы": "Исследуй таблицу и выяви аномальные записи, выбросы и нетипичные паттерны. Оцени их значимость и возможное влияние на общие выводы:",
            "Сводный отчет": "Создай структурированный сводный отчет по всей таблице с ключевыми метриками, выводами и рекомендациями. Включи визуальное представление основных результатов:",
            "Дашборд KPI": "На основе данных таблицы сформируй текстовое описание ключевых показателей эффективности (KPI) с текущими значениями, трендами и рекомендуемыми целями:",
        }
    }
    
    # Плоский список для простого выбора в интерфейсе
    flat_prompts = {}
    for category, category_prompts in prompts.items():
        for name, prompt in category_prompts.items():
            flat_prompts[f"{category}: {name}"] = prompt
            
    return prompts, flat_prompts

def get_prompt_recommendations(data_description: str) -> List[str]:
    """
    Возвращает рекомендуемые промпты на основе описания данных.
    
    Args:
        data_description (str): Описание данных (кол-во строк, столбцов, типы)
        
    Returns:
        List[str]: Список рекомендуемых промптов
    """
    prompts, flat_prompts = get_business_prompts()
    recommendations = []
    
    # Пример простой логики рекомендаций
    if "отзыв" in data_description.lower() or "комментарий" in data_description.lower():
        recommendations.append("Работа с клиентами: Анализ отзыва")
        recommendations.append("Общая аналитика: Ключевые моменты")
    
    if "финанс" in data_description.lower() or "доход" in data_description.lower():
        recommendations.append("Финансы и отчетность: Анализ финансовых данных")
        recommendations.append("Финансы и отчетность: Прогноз на основе данных")
    
    if "продаж" in data_description.lower() or "маркетинг" in data_description.lower():
        recommendations.append("Маркетинг: Анализ конкурента")
        recommendations.append("Текстовая аналитика по всей таблице: Общие тренды")
    
    # Добавляем общие рекомендации, если нет специфических
    if not recommendations:
        recommendations.append("Общая аналитика: Ключевые моменты")
        recommendations.append("Текстовая аналитика по всей таблице: Сводный отчет")
    
    return recommendations

def get_prompt_by_name(prompt_name: str) -> str:
    """
    Возвращает текст промпта по его названию.
    
    Args:
        prompt_name (str): Название промпта в формате "Категория: Название"
        
    Returns:
        str: Текст промпта или пустая строка, если промпт не найден
    """
    _, flat_prompts = get_business_prompts()
    return flat_prompts.get(prompt_name, "")

def customize_prompt(base_prompt: str, context: Dict[str, Any]) -> str:
    """
    Настраивает промпт с учетом контекста.
    
    Args:
        base_prompt (str): Базовый текст промпта
        context (Dict[str, Any]): Контекстная информация
            - target_column: Название целевого столбца
            - additional_columns: Дополнительные столбцы
            - focus_columns: Столбцы для фокуса в анализе всей таблицы
            - row_data: Данные текущей строки (для построчного анализа)
            
    Returns:
        str: Настроенный промпт
    """
    customized_prompt = base_prompt + "\n\n"
    
    if context.get("target_column"):
        customized_prompt += f"Целевой столбец для анализа: {context['target_column']}\n"
    
    if context.get("additional_columns"):
        customized_prompt += f"Дополнительный контекст из столбцов: {', '.join(context['additional_columns'])}\n"
    
    if context.get("focus_columns"):
        customized_prompt += f"Обрати особое внимание на следующие столбцы: {', '.join(context['focus_columns'])}\n"
    
    if context.get("row_data"):
        customized_prompt += "\nДанные для анализа:\n"
        for col, value in context["row_data"].items():
            customized_prompt += f"{col}: {value}\n"
    
    return customized_prompt